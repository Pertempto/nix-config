# Deploy dev-server with nixos-anywhere
deploy target_ip:
    #!/usr/bin/env bash
    set -euo pipefail

    # Prepare install files
    mkdir -p install-files/etc/ssh
    # CRITICAL: SSH requires /etc/ssh to be 755 (not group-writable).
    # mkdir uses umask, which may create 775. This chmod ensures correct
    # permissions are copied to the target system via --extra-files.
    chmod 755 install-files/etc/ssh
    install -m 600 secrets/host-key install-files/etc/ssh/ssh_host_ed25519_key

    # Run nixos-anywhere (skip reboot phase since IP will change)
    nix run github:nix-community/nixos-anywhere -- \
      --flake ../../.#dev-server \
      --extra-files install-files \
      --phases kexec,disko,install \
      --target-host root@{{target_ip}}

    # Cleanup
    rm -rf install-files

    echo ""
    echo "Deployment complete!"
    echo "Next steps:"
    echo "  1. Shut down the VM"
    echo "  1. Remove the installer DVD media from ProxMox"
    echo "  2. Start the VM"
    echo "  3. SSH to addison@192.168.31.23"
