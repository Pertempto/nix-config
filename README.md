# nix-config

This repository holds my NixOS + Home-Manager configuration using the flakes approach for both a USB-drive sandbox installation and a full laptop installation.

> [!WARNING]
> This README was generated by ChatGPT. I will refine it as I figure out what I'm doing. Currently, NixOS is all new to me.

---

## Table of Contents

- [Bootstrap / Initial Setup](#bootstrap-initial-setup)
- [Using the Flake](#using-the-flake)
- [Hosts & Hardware Profiles](#hosts-&-hardware-profiles)
- [Applications & Workflow](#applications-&-workflow)
- [USB Sandbox Strategy](#usb-sandbox-strategy)
- [Migration to Internal Install or Dual-Boot](#migration-to-internal-install-or-dual-boot)
- [Maintenance & Upgrades](#maintenance-&-upgrades)
- [Security & Secrets](#security-&-secrets)
- [Roadmap](#roadmap)
- [License](#license)

---

## Bootstrap / Initial Setup

1. Get "Minimal ISO image" from the [NixOS ISO Download Page](https://nixos.org/download/#nixos-iso)

1. Write it to a USB drive

1. Boot from the USB drive

1. Install to hard drive
   - More info [here](./docs/install.md)

1. Clone this repository:

   ```bash
   git clone https://github.com/pertempto/nix-config.git ~/nix-config
   cd ~/nix-config
   ```

1. If you are setting up a new host - copy the automatically generated `/etc/nixos/hardware-configuration.nix` file to the appropriate `~/nix-config/hosts/` subdirectory.
   - Don't forget to also update the owner and group of the new file.

1. Apply your host configuration:

   ```bash
   # This uses the usbSandbox host, but use the correct one for your system
   sudo nixos-rebuild switch --flake .#usbSandbox
   ```

> [!NOTE]
> One you have installed the flake the first time, you should be able to use the
> `u` alias in ZSH to trigger future updates.

---

## Using the Flake

- Rebuild system configuration:

  ```bash
  sudo nixos-rebuild switch --flake .#<host-name>
  ```

- Update inputs and lock file:

  ```bash
  nix flake update
  git add flake.lock
  git commit -m "chore: update flake inputs"
  ```

---

## Hosts & Hardware Profiles

- **Dev Server** (`devServer`): For my homelab dev server. It runs in a ProxMox virtual machine.
- **USB Sandbox** (`usbSandbox`): For getting started without committing to a full installation to my hard drive.
- **Work Laptop** (`thinkpad`): For my ThinkPad T490 work laptop. I won't start this host until I'm comfortable in the USB sandbox.
- Additional host profiles may be added as needed.

---

## Manual Steps

The following will need copied across manually and should be kept private and secure:
- SSH keys
- GitLab/GitHub auth
- VPN connection configuration
  - OpenVPN3 for work
  - TailScale at home

---

## Maintenance & Upgrades

- Periodically run `nix flake update` to refresh inputs; commit changes.
- Use Git branches when experimenting (e.g., switching compositors).
- Tag stable config releases if desired.
- Keep hardware-specific modules separated for reuse across hosts.

---

## Security & Secrets

- Do not commit secrets (API keys, private keys, credentials).
- Store secrets next to the host/module and name them like `<name>-secrets.nix` or `*-secrets.conf`; keep examples with a `.example` suffix.
- `.gitignore` already ignores `**/*-secrets.nix` and `**/*-secrets.conf`; restrict permissions (e.g. `chmod 600`).
- For stronger protection consider encryption (age/GPG) or a secret manager.

---

## Roadmap

- [x] Create `flake.nix` with proper inputs and outputs.
- [x] Define `usbSandbox` profile.
- [x] Install NixOS on USB drive (sandbox) and apply config.
- [x] Create Home-Manager config for user `addison`.
- [x] Test hardware (WiFi, GPU, battery, power) on sandbox.
- [x] List current applications from Pop!\_OS and check availability.
- [x] Iterate configuration until system and home workflows are stable.
- [x] Backup Pop!\_OS data.
- [x] Define `thinkpad` profile.
- [ ] Install NixOS on internal drive.
- [ ] Clone repo on internal install and apply `thinkpad` profile.
- [ ] Verify everything works.
- [ ] Set up `nix.gc`.
- [ ] Set up `nix.optimise`.
- [ ] Set up weekly slack reminder to run `nix flake update`

---

## License

This configuration is licensed under the [MIT License](LICENSE).
Feel free to fork and adapt, though your hardware and preferences may differ.
